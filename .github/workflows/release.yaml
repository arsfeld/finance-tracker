name: Release
on:
  push:
    tags:
      - 'v*'  # Trigger on version tags
    branches:
      - master
      - main

env:
  RUST_TOOLCHAIN: stable
  TOOLCHAIN_PROFILE: minimal

jobs:
  build:
    name: Build Binary
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
      
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
      
      - name: Build release binary
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary
          path: target/release/*

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build]  # This ensures we wait for the build job
    if: startsWith(github.ref, 'refs/tags/v')  # Only run on version tags

    permissions:
      contents: write  # Needed for creating releases

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: binary  # This matches the name from the build job's upload
          path: release-bins
          merge-multiple: false  # Ensure we only get artifacts from this run

      - name: List files
        run: ls -la release-bins/
        
      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Strip the 'refs/tags/' prefix
          VERSION=${GITHUB_REF#refs/tags/}
          
          # Create a new release
          gh release create "$VERSION" \
            --title "$VERSION" \
            --generate-notes \
            release-bins/*

  tag-release:
    name: Create New Version Tag
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    permissions:
      contents: write  # Needed for creating tags

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags
      
      - name: Get latest tag
        id: get_latest_tag
        run: |
          git fetch --tags
          latest_tag=$(git tag -l 'v*' --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            echo "version=v0.1.0" >> "$GITHUB_OUTPUT"
          else
            # Increment patch version
            version=$(echo "$latest_tag" | awk -F. '{$NF+=1; OFS="."; print $0}')
            echo "version=$version" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          new_tag=${{ steps.get_latest_tag.outputs.version }}
          git tag "$new_tag"
          git push origin "$new_tag"
          echo "Created and pushed new tag: $new_tag" 